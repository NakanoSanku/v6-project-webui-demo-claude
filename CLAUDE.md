# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a hybrid AutoX v6 + Vite + Vue 3 + TypeScript WebView application. The project embeds a modern web UI (built with Vue 3 and Framework7) into an AutoX v6 Android automation script via WebView, enabling bidirectional communication through a JavaScript Bridge.

**Key Architecture:**

- **Web Frontend** (`src/`): Vue 3 + Framework7 UI served via Vite dev server (development) or bundled static files (production)
- **AutoX Script** (`src-autox/`): TypeScript/JSX entry point that creates a native UI with embedded WebView
- **Build Scripts** (`scrpits/`): Node.js ESM scripts for building, deploying, and pushing to Android devices
- **JS Bridge**: Bidirectional communication layer between Web UI and AutoX native environment

## Common Commands

### Development

```bash
# Install dependencies
npm install

# Web UI only (browser development, no AutoX required)
npm run dev
# Runs Vite dev server on http://localhost:5173
# AutoX SDK won't be available but UI will render normally

# AutoX development (recommended for full integration testing)
npm run dev
# (in separate terminal)
npm run dev-autox
# Compiles AutoX scripts, pushes to device, runs in AutoX WebView
# WebView loads from http://<dev-ip>:5173/ for hot-reload
```

### Building

```bash
# Build web UI only
npm run build
# Outputs to dist/

# Build complete AutoX project (web + scripts)
npm run build-autox
# 1. Runs npm run build (web → dist/)
# 2. Compiles src-autox/ → dist-autox/
# 3. Copies dist/ → dist-autox/website/

# Build and save to device as AutoX project
npm run save-autox
# Same as build-autox, then zips and saves to device via HTTP API
```

### TypeScript

```bash
# Type-check web code
vue-tsc -b --project tsconfig.app.json

# Type-check AutoX code
vue-tsc -b --project tsconfig.autox.json
```

## Critical Development Constraints

### AutoX-Specific Rules

**Before modifying ANY AutoX code** (`src-autox/`, `scrpits/`), use Context7 read https://context7.com/websites/autoxjs_dayudada for platform-specific APIs and conventions.

1. **JSX Configuration**: AutoX uses custom JSX with `jsxFactory: "ui.h"` (see `tsconfig.autox.json:13`)

   - Write `<frame>`, `<webview>`, etc. for UI layouts
   - Different from React - uses AutoX's UI rendering engine
2. **Module System**: AutoX scripts are bundled to CommonJS by Rollup

   - Entry: `src-autox/main.tsx` → Output: `dist-autox/main.js`
   - Use `import`/`export` in source; Rollup handles transformation
3. **Global Variables**: AutoX provides globals like `ui`, `files`, `toastLog`, `exit`, etc.

   - No imports needed - see `autox-v6-api` typings in `node_modules/`
   - Reference documentation in Context7 https://context7.com/websites/autoxjs_dayudada

### Build System Architecture

**Rollup Build Flow** (`scrpits/tasks.mjs`):

1. TypeScript compilation via `vue-tsc -b`
2. Rollup bundles `dist-autox/main.js` (temporary TS output) → final `dist-autox/main.js`
3. **Critical Replacement Variables**:
   - `__DevIp__`: Replaced with device IP (dev mode) or left undefined (production)
   - `__DevModel__`: Replaced with `true` (dev) or `false` (production)
4. Files copied: `src-autox/start-ui.js` and `src-autox/project.json` → `dist-autox/`

**Never modify**:

- `dist/` - Vite output (regenerated on `npm run build`)
- `dist-autox/` - Rollup output (regenerated by build scripts)

### JavaScript Bridge Protocol

**Web → AutoX** (`src/js_bridge.ts`):

```ts
import { callHandler } from '@/js_bridge'
callHandler('eventName', 'payload', (response) => {
  // optional callback
})
```

**AutoX → Web** (`src-autox/main.tsx`):

```ts
jsBridge.registerHandler('eventName', (data: string, callback?: (response: string) => void) => {
  // handle event
  callback?.('response')
})
```

**Rules**:

- Always use `js_bridge.ts` exports in web code - never access `$autox` directly
- Keep event names as constants to avoid typos
- Web code must gracefully handle missing `$autox` (browser environment)
- All data passed as strings (JSON.stringify/parse for complex data)

### Directory Structure Conventions

```
src/
├── App.vue              # Root component with Framework7 app wrapper
├── components/          # Vue components (HomePage .vue, etc.)
├── js_bridge.ts         # MANDATORY interface for AutoX communication
└── main.ts              # Web entry point

src-autox/
├── main.tsx             # AutoX entry (JSX UI layout + WebView setup)
├── start-ui.js          # AutoX launch file (loads main.js)
└── project.json         # AutoX project metadata (name, package, version)

scrpits/
├── tasks.mjs            # Core build utilities (rollupBuild, copyWebsite, getip)
├── dev-autox.mjs        # Dev workflow: build → push → run on device
├── build-autox.mjs      # Production build: web + AutoX
└── save-autox.mjs       # Build + save as named project on device

tsconfig.*.json
├── tsconfig.json        # Base config
├── tsconfig.app.json    # Web code (src/) - Vue SFC support
├── tsconfig.autox.json  # AutoX code (src-autox/) - JSX with ui.h
└── tsconfig.node.json   # Build scripts (scrpits/)
```

## Framework7 UI Patterns

This project uses Framework7 Vue components (v8.x):

```vue
<template>
  <f7-page>
    <f7-navbar title="Title" />
    <f7-list>
      <f7-list-item title="Item" @click="onClick" />
    </f7-list>
    <f7-button @click="doAction">Action</f7-button>
  </f7-page>
</template>
```

**Do NOT**:

- Mix other UI frameworks (Vuetify, Element, etc.)
- Add conflicting CSS frameworks
- Modify Framework7 initialization in `App.vue` without understanding params

## Device Communication Setup

### IP Address Management

- Device IP cached in `.deviceIpAddress` (gitignored)
- First run of `dev-autox` or `save-autox` prompts for IP
- Subsequent runs use cached value (can override by editing file)

### AutoX HTTP API

Device must expose `http://<ip>:9317/api/v1` with:

- `?type=getip` - Returns `{ remoteHost: "192.168.x.x" }`
- `?type=runProject&dirName=<name>` - Receives zip, runs immediately
- `?type=saveProject&saveName=<name>` - Receives zip, saves to projects

### Development Workflow

1. **First time**: Run `npm run dev-autox`, enter device IP when prompted
2. **Web changes**: Edit `src/`, Vite hot-reloads automatically in WebView
3. **AutoX changes**: Edit `src-autox/`, re-run `npm run dev-autox` to rebuild and push
4. **Deployment**: Use `npm run save-autox` to create permanent project on device

## TypeScript Configuration Notes

- **Web** (`tsconfig.app.json`): `"jsx": "preserve"` for Vue SFC
- **AutoX** (`tsconfig.autox.json`): `"jsx": "react", "jsxFactory": "ui.h"` for AutoX JSX
- **Strict mode enabled** for both - avoid `any`, prefer explicit types
- AutoX globals typed via `autox-v6-api` package

## Common Modifications

### Adding a new Web → AutoX event

1. Web side (`src/components/YourComponent.vue`):

   ```ts
   import { callHandler } from '@/js_bridge'

   function handleAction() {
     callHandler('yourEvent', JSON.stringify({ data: 'value' }))
   }
   ```
2. AutoX side (`src-autox/main.tsx`):

   ```ts
   jsBridge.registerHandler('yourEvent', (data: string) => {
     const payload = JSON.parse(data)
     toastLog('Received: ' + payload.data)
   })
   ```

### Modifying AutoX UI Layout

Edit `src-autox/main.tsx`:

```tsx
ui.layout(
  <frame>
    <webview id="webview" />
    {/* Add more native components here */}
  </frame>
)
```

**Important**: Keep WebView as primary component - this is a WebView-centric architecture.

### Changing WebView URL Logic

In `src-autox/main.tsx`:

```ts
declare var __DevIp__: string
if (typeof __DevIp__ === 'string') {
  webView.loadUrl(`http://${__DevIp__}:5173/`)  // Dev mode
} else {
  webView.loadLocalFile(files.path('./website')) // Production mode
}
```

**Do NOT** remove the production branch or replace `__DevIp__` manually - it's replaced during Rollup build.

## Troubleshooting

### Build fails with "Cannot find module"

- Run `npm install` to ensure all dependencies installed
- Check `tsconfig.*.json` paths match your imports

### Device connection fails

- Verify device and dev machine on same network
- Ensure AutoX HTTP service running on port 9317
- Check `.deviceIpAddress` contains correct IP

### WebView shows blank page

- Check browser console for errors (use `npm run dev` in browser first)
- Verify AutoX is loading correct URL (check `__DevIp__` replacement)
- Ensure `autox://sdk.v1.js` script tag in `index.htm】`

### JS Bridge not working

- Confirm `$autox` is defined (only works in AutoX WebView)
- Check `js_bridge.ts` for environment detection warnings
- Verify handler names match exactly between web and AutoX sides

## Additional Resources

- **AutoX API Reference**: Use Context7 MCP Search https://context7.com/websites/autoxjs_dayudada
- **Framework7 Docs**: https://framework7.io/vue/
- **Vite Docs**: https://vitejs.dev/
- **AutoX v6 Types**: `node_modules/autox-v6-api/index.d.ts`
